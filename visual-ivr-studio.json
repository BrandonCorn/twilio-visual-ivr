{
    "description": "A New Flow",
    "states": [
      {
        "name": "Trigger",
        "type": "trigger",
        "transitions": [
          {
            "event": "incomingMessage"
          },
          {
            "next": "choice_visual_ivr",
            "event": "incomingCall"
          },
          {
            "event": "incomingRequest"
          },
          {
            "event": "incomingParent"
          }
        ],
        "properties": {
          "offset": {
            "x": 0,
            "y": 0
          }
        }
      },
      {
        "name": "choice_visual_ivr",
        "type": "gather-input-on-call",
        "transitions": [
          {
            "next": "choice_press",
            "event": "keypress"
          },
          {
            "next": "choice_speech",
            "event": "speech"
          },
          {
            "next": "choice_visual_ivr",
            "event": "timeout"
          }
        ],
        "properties": {
          "voice": "Polly.Amy",
          "number_of_digits": 1,
          "speech_timeout": "auto",
          "offset": {
            "x": 80,
            "y": 230
          },
          "loop": 1,
          "finish_on_key": "#",
          "say": "Hey, welcome to the Twilio IVR. Would you like to interact with our new visual IVR? Press 1 for yes, press 2 for no.",
          "language": "en-GB",
          "stop_gather": true,
          "gather_language": "en-US",
          "profanity_filter": "true",
          "timeout": 5
        }
      },
      {
        "name": "choice_press",
        "type": "split-based-on",
        "transitions": [
          {
            "next": "error_choice_visual_ivr",
            "event": "noMatch"
          },
          {
            "next": "get-conference-name",
            "event": "match",
            "conditions": [
              {
                "friendly_name": "If value equal_to 1",
                "arguments": [
                  "{{widgets.choice_visual_ivr.Digits}}"
                ],
                "type": "equal_to",
                "value": "1"
              }
            ]
          }
        ],
        "properties": {
          "input": "{{widgets.choice_visual_ivr.Digits}}",
          "offset": {
            "x": -220,
            "y": 570
          }
        }
      },
      {
        "name": "choice_speech",
        "type": "split-based-on",
        "transitions": [
          {
            "next": "error_choice_visual_ivr",
            "event": "noMatch"
          },
          {
            "next": "get-conference-name",
            "event": "match",
            "conditions": [
              {
                "friendly_name": "If value equal_to Yes",
                "arguments": [
                  "{{widgets.choice_visual_ivr.SpeechResult}}"
                ],
                "type": "equal_to",
                "value": "Yes"
              }
            ]
          }
        ],
        "properties": {
          "input": "{{widgets.choice_visual_ivr.SpeechResult}}",
          "offset": {
            "x": 260,
            "y": 560
          }
        }
      },
      {
        "name": "send_message_1",
        "type": "send-message",
        "transitions": [
          {
            "next": "connect-ivr-to-conference",
            "event": "sent"
          },
          {
            "next": "choice_visual_ivr",
            "event": "failed"
          }
        ],
        "properties": {
          "offset": {
            "x": 250,
            "y": 1370
          },
          "service": "{{trigger.message.InstanceSid}}",
          "channel": "{{trigger.message.ChannelSid}}",
          "from": "{{flow.channel.address}}",
          "to": "{{contact.channel.address}}",
          "body": "https://4eda-23-28-173-29.ngrok.io/ivr-menu?conference={{flow.variables.conference}}"
        }
      },
      {
        "name": "set-conference-name",
        "type": "set-variables",
        "transitions": [
          {
            "next": "send_message_1",
            "event": "next"
          }
        ],
        "properties": {
          "variables": [
            {
              "value": "{{widgets.get-conference-name.parsed.conference}}",
              "key": "conference"
            }
          ],
          "offset": {
            "x": 190,
            "y": 1150
          }
        }
      },
      {
        "name": "connect-to-conference",
        "type": "add-twiml-redirect",
        "transitions": [
          {
            "event": "return"
          },
          {
            "event": "timeout"
          },
          {
            "event": "fail"
          }
        ],
        "properties": {
          "offset": {
            "x": 260,
            "y": 1880
          },
          "method": "POST",
          "url": "https://visual-ivr-functions-4076-dev.twil.io/connect-to-conference?conference={{flow.variables.conference}}",
          "timeout": "14400"
        }
      },
      {
        "name": "get-conference-name",
        "type": "run-function",
        "transitions": [
          {
            "next": "set-conference-name",
            "event": "success"
          },
          {
            "next": "choice_visual_ivr",
            "event": "fail"
          }
        ],
        "properties": {
          "service_sid": "ZS66cf609a9bbc0ab7ee04ed7a8105c116",
          "environment_sid": "ZE26f02bc4fa8d21dc3b1f6b37e7a89d4a",
          "offset": {
            "x": 190,
            "y": 900
          },
          "function_sid": "ZH11a9766f060c18aac6956db22569da3f",
          "url": "https://visual-ivr-functions-4076-dev.twil.io/get-conference-name"
        }
      },
      {
        "name": "connect-ivr-to-conference",
        "type": "run-function",
        "transitions": [
          {
            "next": "connect-to-conference",
            "event": "success"
          },
          {
            "event": "fail"
          }
        ],
        "properties": {
          "service_sid": "ZS66cf609a9bbc0ab7ee04ed7a8105c116",
          "environment_sid": "ZE26f02bc4fa8d21dc3b1f6b37e7a89d4a",
          "offset": {
            "x": 240,
            "y": 1610
          },
          "function_sid": "ZHd3edaa240fa4bab0ca46336f56f2a277",
          "parameters": [
            {
              "value": "{{flow.channel.address}}",
              "key": "From"
            },
            {
              "value": "+17067864318",
              "key": "To"
            },
            {
              "value": "{{flow.variables.conference}}",
              "key": "Conference"
            }
          ],
          "url": "https://visual-ivr-functions-4076-dev.twil.io/connect-ivr-to-conference"
        }
      },
      {
        "name": "error_choice_visual_ivr",
        "type": "gather-input-on-call",
        "transitions": [
          {
            "next": "choice_press",
            "event": "keypress"
          },
          {
            "next": "choice_speech",
            "event": "speech"
          },
          {
            "next": "error_choice_visual_ivr",
            "event": "timeout"
          }
        ],
        "properties": {
          "voice": "Polly.Amy",
          "number_of_digits": 1,
          "speech_timeout": "auto",
          "offset": {
            "x": 860,
            "y": 400
          },
          "loop": 1,
          "finish_on_key": "#",
          "say": "We're sorry, we're having trouble some trouble. Please press 1 to interact with our new visual IVR. Press 2 to continue",
          "language": "en-GB",
          "stop_gather": true,
          "gather_language": "en-US",
          "profanity_filter": "true",
          "timeout": 5
        }
      }
    ],
    "initial_state": "Trigger",
    "flags": {
      "allow_concurrent_calls": true
    }
  }